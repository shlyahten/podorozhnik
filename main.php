<?php
// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Telegram Bot API
require 'vendor/autoload.php';

use Telegram\Bot\Api;

$botToken = getenv('BOT_TOKEN'); // Telegram Bot Token
$bot = new Api($botToken);
date_default_timezone_set('Europe/Moscow');

// –í–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);
ini_set('error_log', __DIR__ . '/error_log.txt');


// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ —Ñ–∞–π–ª
function saveTokenToFile($chatId, $refreshToken, $token) {
    $filePath = __DIR__ . '/db.txt';
    $newData = "$chatId:$refreshToken:$token" . PHP_EOL;
    $fileContents = file_exists($filePath) ? file($filePath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES) : [];
    $fileContents = array_map(function($line) use ($chatId, $newData) {
        return strpos($line, "$chatId:") === 0 ? trim($newData) : $line;
    }, $fileContents);

    if (!in_array(trim($newData), $fileContents)) {
        $fileContents[] = trim($newData);
    }

    file_put_contents($filePath, implode(PHP_EOL, $fileContents) . PHP_EOL, LOCK_EX);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
function refreshToken($refreshToken) {
    return makeApiRequest('https://mobile-vpb.orgp.spb.ru/user/refreshtoken', "Bearer $refreshToken");
}

// –ß—Ç–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞
function getTokensFromFile($chatId) {
    $filePath = __DIR__ . '/db.txt';
    if (!file_exists($filePath)) {
        return ['error' => '–§–∞–π–ª —Å —Ç–æ–∫–µ–Ω–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω'];
    }

    foreach (file($filePath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES) as $line) {
        list($storedChatId, $storedRefreshToken, $storedToken) = explode(':', $line, 3);
        if ($storedChatId == $chatId) {
            return ['refreshToken' => $storedRefreshToken, 'token' => $storedToken];
        }
    }

    return ['error' => '–¢–æ–∫–µ–Ω—ã –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'];
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –≤ —Ñ–∞–π–ª p_db.txt
function savePodorozhnikTokenToFile($chatId, $userId, $token) {
    $filePath = __DIR__ . '/p_db.txt';
    $newData = "$chatId:$userId:$token" . PHP_EOL;
    $fileContents = file_exists($filePath) ? file($filePath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES) : [];
    $fileContents = array_map(function($line) use ($chatId, $newData) {
        return strpos($line, "$chatId:") === 0 ? trim($newData) : $line;
    }, $fileContents);

    if (!in_array(trim($newData), $fileContents)) {
        $fileContents[] = trim($newData);
    }

    file_put_contents($filePath, implode(PHP_EOL, $fileContents) . PHP_EOL, LOCK_EX);
}

// –ß—Ç–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞
function getPodorozhnikTokensFromFile($chatId) {
    $filePath = __DIR__ . '/p_db.txt';
    if (!file_exists($filePath)) {
        return ['error' => '–§–∞–π–ª —Å —Ç–æ–∫–µ–Ω–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω'];
    }

    foreach (file($filePath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES) as $line) {
        list($storedChatId, $storedUserId, $storedToken) = explode(':', $line, 3);
        if ($storedChatId == $chatId) {
            return ['userId' => $storedUserId, 'token' => $storedToken];
        }
    }

    return ['error' => '–¢–æ–∫–µ–Ω—ã –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'];
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è API-–∑–∞–ø—Ä–æ—Å–æ–≤
function makeApiRequest($url, $authHeader = null, $data = null, $extraHeaders = []) {
    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, array_merge(array_filter([
        'User-Agent: okhttp/4.9.2',
        'Connection: Keep-Alive',
        'Accept: application/json, text/plain, */*',
        'Accept-Encoding: gzip',
        $authHeader ? "authorization: $authHeader" : null,
        $data ? 'Content-Type: application/json' : null
    ]), $extraHeaders));
    if ($data) {
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    }
    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

    $response = curl_exec($ch);
    $error = curl_error($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($response === false) {
        return ['error' => $error ?: "HTTP $httpCode"];
    }

    $decodedResponse = json_decode($response, true);
    if ($decodedResponse === null) {
        return ['error' => '–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JSON'];
    }

    if ($httpCode !== 200) {
        return ['error' => "HTTP $httpCode: " . ($decodedResponse['message'] ?? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')];
    }

    return $decodedResponse;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–µ–∑–¥–æ–∫
function getTrips($token) {
    $response = makeApiRequest('https://mobile-vpb.orgp.spb.ru/trips/gettrips?vpb=false', "Bearer $token");
	return $response;
}
function setTrips($response) {
	    if (isset($response['error'])) {
        return "–û—à–∏–±–∫–∞: {$response['error']}";
    }

    if (!isset($response['items']) || !is_array($response['items'])) {
        return "–û—à–∏–±–∫–∞: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞.";
    }

    usort($response['items'], fn($a, $b) => strtotime($a['dateTime']) - strtotime($b['dateTime']));

    $emojiMap = [
        '–¢—Ä–æ–ª–ª–µ–π–±—É—Å' => 'üöé',
        '–ê–≤—Ç–æ–±—É—Å' => 'üöå',
        '–¢—Ä–∞–º–≤–∞–π' => 'üöã'
    ];

    $result = "–°–ø–∏—Å–æ–∫ –ø–æ–µ–∑–¥–æ–∫:\n";
    foreach ($response['items'] as $trip) {
        $date = (new DateTime($trip['dateTime']))->setTimezone(new DateTimeZone('Europe/Moscow'))->format('d.m H:i');
        $route = $trip['vehicleRoute'];
        $type = $emojiMap[$trip['vehicleType']] ?? $trip['vehicleType'];
        $amount = number_format($trip['amountInMinorUnits'] / 100, 2, '.', '');
        $result .= "$date - ‚Ññ $route - $type - –°—Ç–æ–∏–º–æ—Å—Ç—å: $amount —Ä—É–±.\n";
    }

    return $result;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π
function getPayments($token) {
    $podorozhnikHeader = [
        'x-ppa-mobile-app-request: mobile app'
    ];
    $response = makeApiRequest('https://podorozhnik.spb.ru/api/payment', "Bearer $token", null, $podorozhnikHeader);

    return $response;
}
function setPayments($response) {
	if (isset($response['error'])) {
        return "–û—à–∏–±–∫–∞: {$response['error']}";
    }

    if (!isset($response['items']) || !is_array($response['items'])) {
        return "–û—à–∏–±–∫–∞: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞.";
    }

    usort($response['items'], fn($a, $b) => strtotime($a['dateTime']) - strtotime($b['dateTime']));

    $result = "–°–ø–∏—Å–æ–∫ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π:\n";
    foreach ($response['items'] as $payment) {
        $date = (new DateTime($payment['dateTime']))->setTimezone(new DateTimeZone('Europe/Moscow'))->format('d.m H:i');
        $amount = number_format($payment['amountInMinor'] / 100, 2, '.', '');
        $ticketDescription = $payment['ticketTypeDescription'] ?? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –±–∏–ª–µ—Ç–∞';
        $paymentStatus = $payment['statuses']['PaymentStatus'] ?? '–°—Ç–∞—Ç—É—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
        $rechargeStatus = $payment['statuses']['RechargeStatus'] ?? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å';
        $resource = $payment['statuses']['Resource'] ?? '–†–µ—Å—É—Ä—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';

        $result .= "$date - $ticketDescription\n";
        $result .= "  –°—É–º–º–∞: $amount —Ä—É–±.\n";
        $result .= "  –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã: $paymentStatus\n";
        $result .= "  –°—Ç–∞—Ç—É—Å –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: $rechargeStatus\n";
        $result .= "  –û—Å—Ç–∞—Ç–æ–∫: $resource\n\n";
    }

    return $result;
}

// –ü–æ–¥—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–∞
function calculateBalance($trips, $payments) {
    if (!isset($trips['items']) || !is_array($trips['items'])) {
        return "–û—à–∏–±–∫–∞: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–µ–∑–¥–∫–∞—Ö.";
    }

    if (!isset($payments['items']) || !is_array($payments['items'])) {
        return "–û—à–∏–±–∫–∞: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è—Ö.";
    }

    $tripsList = [];
    foreach ($trips['items'] as $trip) {
        $tripsList[] = [
            'dateTime' => (new DateTime($trip['dateTime']))->setTimezone(new DateTimeZone('Europe/Moscow'))->format('Y-m-d H:i:s'),
            'amount' => $trip['amountInMinorUnits'] / 100 // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Ä—É–±–ª–∏
        ];
    }

    $paymentsList = [];
    foreach ($payments['items'] as $payment) {
        $paymentsList[] = [
            'dateTime' => (new DateTime($payment['dateTime']))->setTimezone(new DateTimeZone('Europe/Moscow'))->format('Y-m-d H:i:s'),
            'resource' => convertToMinorUnits($payment['statuses']['Resource']) / 100 // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Ä—É–±–ª–∏
        ];
    }

    if (empty($tripsList) || empty($paymentsList)) {
        return "–û—à–∏–±–∫–∞: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞.";
    }

    $latestPayment = end($paymentsList);
    $currentBalance = $latestPayment['resource'];
    $lastPaymentDate = new DateTime($latestPayment['dateTime']);

    $calculationDetails = "–ü–æ—Å–ª–µ–¥–Ω–∏–π –±–∞–ª–∞–Ω—Å –Ω–∞ –º–æ–º–µ–Ω—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è ({$lastPaymentDate->format('d.m H:i')}): {$currentBalance} —Ä—É–±.\n";
    $calculationDetails .= "–°–ø–∏—Å–æ–∫ –ø–æ–µ–∑–¥–æ–∫ –ø–æ—Å–ª–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:\n";

    foreach ($tripsList as $trip) {
        $tripDate = new DateTime($trip['dateTime']);
        if ($tripDate > $lastPaymentDate) {
            $currentBalance -= $trip['amount'];
            $calculationDetails .= "{$tripDate->format('d.m H:i')} - –°—Ç–æ–∏–º–æ—Å—Ç—å: {$trip['amount']} —Ä—É–±.\n";
        }
    }

    $calculationDetails .= "\n–¢–µ–∫—É—â–∏–π —Ä–∞—Å—á–µ—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å: " . number_format($currentBalance, 2, '.', '') . " —Ä—É–±.";
    return $calculationDetails;
}

// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ amountInMinor
function convertToMinorUnits($input) {
    if (empty($input)) {
        return 0; // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø—É—Å—Ç–∞—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 0
    }

    $numericValue = preg_replace('/[^\d.]/', '', $input);
    return (int)($numericValue * 100);
}

// –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
$update = $bot->getWebhookUpdate();

if (isset($update['message']['text'])) {
    $message = $update['message']['text'];
    $chatId = $update['message']['chat']['id'];

    if (strpos($message, ':') !== false) {
    list($login, $password) = explode(':', $message, 2);

    // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å
    $vpbData = [
        'email' => $login,
        'password' => $password,
        'device' => '1e1d1d1aee11e1aa...11a1b...aa1tk'
    ];
    $vpbResponse = makeApiRequest('https://mobile-vpb.orgp.spb.ru/user/login', null, $vpbData);

    if (isset($vpbResponse['userData'], $vpbResponse['token'], $vpbResponse['refresh'])) {
        saveTokenToFile($chatId, $vpbResponse['refresh'], $vpbResponse['token']);
        $reply1 = "–ö–æ–¥ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞: 200\n" .
                  "userId: {$vpbResponse['userData']['userId']}\n" .
                  "email: {$vpbResponse['userData']['email']}\n" .
                  "–ò–º—è: {$vpbResponse['userData']['firstName']}\n" .
                  "–§–∞–º–∏–ª–∏—è: {$vpbResponse['userData']['surname']}\n" .
                  "–¢–æ–∫–µ–Ω: {$vpbResponse['token']}\n" .
                  "–†–µ—Ñ—Ä–µ—à —Ç–æ–∫–µ–Ω: {$vpbResponse['refresh']}";
    } else {
        $reply1 = "–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: " . print_r($vpbResponse, true);
    }

    // –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å
	$podorozhnikHeader = [
    'x-ppa-mobile-app-request: mobile app'
    ];
    $podorozhnikData = [
        'login' => $login,
        'password' => $password
    ];
    $podorozhnikResponse = makeApiRequest(
        'https://podorozhnik.spb.ru/api/auth/login',
        "Bearer", // –ó–∞–≥–æ–ª–æ–≤–æ–∫ "Bearer" –Ω—É–∂–µ–Ω, –æ–Ω –ø—É—Å—Ç–æ–π –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ
        $podorozhnikData,
        $podorozhnikHeader
    );

    if (isset($podorozhnikResponse['token'], $podorozhnikResponse['id'])) {
        savePodorozhnikTokenToFile($chatId, $podorozhnikResponse['id'], $podorozhnikResponse['token']);
        $reply2 = "–£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:\n" .
                  "ID: {$podorozhnikResponse['id']}\n" .
                  "Email: {$podorozhnikResponse['email']}\n" .
                  "–ò–º—è: {$podorozhnikResponse['firstName']}\n" .
                  "–§–∞–º–∏–ª–∏—è: {$podorozhnikResponse['surname']}\n" .
                  "–¢–æ–∫–µ–Ω: {$podorozhnikResponse['token']}";
    } else {
        $reply2 = "–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è. –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: " . print_r($podorozhnikResponse, true);
    }

    $reply = "{$reply1}\n--------------------\n{$reply2}";
} elseif (strpos($message, '/refresh') === 0) {
        $tokens = getTokensFromFile($chatId);

        if (isset($tokens['error'])) {
            $reply = "–û—à–∏–±–∫–∞: {$tokens['error']}";
        } else {
            $newTokens = refreshToken($tokens['refreshToken']);

            if (isset($newTokens['error'])) {
                $reply = "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: {$newTokens['error']}";
            } else {
                saveTokenToFile($chatId, $newTokens['refresh'], $newTokens['token']);
                $reply = "–¢–æ–∫–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã:\n–ù–æ–≤—ã–π —Ç–æ–∫–µ–Ω: {$newTokens['token']}\n–ù–æ–≤—ã–π —Ä–µ—Ñ—Ä–µ—à —Ç–æ–∫–µ–Ω: {$newTokens['refresh']}";
            }
        }
    } elseif (strpos($message, '/trips') === 0) {
        $tokens = getTokensFromFile($chatId);

        if (isset($tokens['error'])) {
            $reply = "–û—à–∏–±–∫–∞: {$tokens['error']}";
        } else {
            $response = getTrips($tokens['token']);
			$reply = setTrips($response);
        }
    } elseif (strpos($message, '/payments') === 0) {
        $tokens = getPodorozhnikTokensFromFile($chatId);

        if (isset($tokens['error'])) {
            $reply = "–û—à–∏–±–∫–∞: {$tokens['error']}";
        } else {
            $response = getPayments($tokens['token']);
			$reply = setPayments($response);
        }
   } elseif (strpos($message, '/calc') === 0) {
    $vpbTokens = getTokensFromFile($chatId);
    $podorozhnikTokens = getPodorozhnikTokensFromFile($chatId);

    if (isset($vpbTokens['error']) || isset($podorozhnikTokens['error'])) {
        $reply = "–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞.";
    } else {
        $trips = getTrips($vpbTokens['token']);
        $payments = getPayments($podorozhnikTokens['token']);

            $reply = calculateBalance($trips, $payments);
    }
} else {
        $reply = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ª–æ–≥–∏–Ω:–ø–∞—Ä–æ–ª—å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞.";
    }

    $bot->sendMessage([
        'chat_id' => $chatId,
        'text' => $reply
    ]);
}
?>
